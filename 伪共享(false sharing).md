# 伪共享(false sharing)说明

## 介绍

缓存系统中以缓存行(cache line)为单位存储，当多线程修改互相独立的变量时，如果这些变量共享同一个缓存行，就会影响彼此的性能，这就是伪共享。

## 前期知识提要

### CPU缓存

CPU缓存是位于CPU和内存之间的临时存储器，分为三个等级，分别是：

- L1，最小但是最快的缓存，每个core都有自己的L1缓存；能存储2kb到64kb
- L2，略大也略慢，每个core都有自己的L2缓存；能存储256kb到512kb
- L3，也被叫做末级缓存(last level cache)，位于CPU外部，被所有core共享。主要作用于数据共享和core之间通信；通常在1mb到8mb之间

### MESI协议

CPU的每个core都有私有的L1和L2缓存，如果多线程编程时另一个core需要访问当前core的私有缓存，就需要MESI协议。

MESI协议是一个基于失效的缓存一致性的协议，规定了缓存行有4中状态：

- M：Modified，缓存行被修改过(dirty)，和主存的值不同，如果别的core需要读主存的这块数据，该缓存行必须写回主存，状态变为S
- E：Exclusive(独占)，缓存行只在当前的缓存中且数据是clean的，和主存的数据一样，当别的缓存读取缓存行时，状态变为S；当前core写数据时，状态变为M
- S：shared，缓存行也存在于其他缓存且数据是clean的。数据行可以任意时间抛弃。
- I：缓存行无效。

### 缓存行

缓存中以缓存行为单位来存储，通常情况下是64字节。例如java中long类型是8字节，因此在一个缓存行中可以存8个long类型的变量，所以访问一个long数组时，会将数组中的8个元素加载到缓存行中。

因此，连续内存块中分配的数据结构都可以非常快速的遍历。不相邻的数据结构，例如链表，每一个元素都可以未命中缓存。

## 伪共享代码示例

参考: [代码示例](https://www.cnblogs.com/cyfonly/p/5800758.html)